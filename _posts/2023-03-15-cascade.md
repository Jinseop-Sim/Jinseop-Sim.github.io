---
layout: post
title: "다대다 관계와 객체의 삭제에 관하여"
categories: ToyProject
tags: [develop]
author:
  - Jinseop Sim
---
프로젝트가 거의 마무리를 지어가나 싶더니 문제가 발생했다.  
회원 탈퇴 기능을 개발할 때에 발생한 문제이다.  

아래와 같이 연관관계가 있는 Attribute들에 대해서 Option을 걸었다.  
<img width="911" alt="KakaoTalk_20230318_150152547" src="https://user-images.githubusercontent.com/71700079/226089438-99e31b68-60eb-47e4-99e3-bcd1e09095c1.png">  
<img width="909" alt="KakaoTalk_20230318_150204577" src="https://user-images.githubusercontent.com/71700079/226089441-3c47efb6-6c0e-45d3-ba30-6905daae29c9.png">  
```CASCADE```와 ```orphanRemoval```을 통해 연관 객체를 모두 관리할 계획이었다.  
하지만, 이 부분에서 문제가 발생했다.  

일반적으로 그냥 내가 쓴 글 정도는 회원 탈퇴가 잘 수행되었다.  
회원 객체와 함께 연관된 글도 모두 삭제되었다.  
하지만 문제는 다대다 관계에서 발생했다.  

현재 프로젝트에서는 __찜__ 기능과 __참여__ 기능이 다대다 관계이다.  
다대다 관계를 교차 엔티티를 통해 해소를 해놓은 상태인데,  
해당 객체가 지워지지 않으니 아래와 같은 문제가 발생했다.  
<img width="1249" alt="KakaoTalk_20230318_151403039" src="https://user-images.githubusercontent.com/71700079/226089450-054f423c-207e-4c6b-85ef-be2624f69b2c.png">  
<img width="541" alt="KakaoTalk_20230318_151500029" src="https://user-images.githubusercontent.com/71700079/226089453-c55a7a51-4af3-494e-9fa1-0bc8bdf968ad.png">  

나는 그래서 아래의 사항들에 대해 고민해보기로 했다.  
1. 애초에 연관 관계가 제대로 설정이 되어있는가?
2. ```CASCADE```와 ```orphanRemoval``` Option의 무분별한 사용은 괜찮은가?
3. 로직을 따로 추가해 교차 엔티티 삭제를 먼저 해주어야 할까?

### 연관 관계의 설정
현재 아래의 사진과 같이 연관 관계가 설정되어있다.
[사진 첨부]

연관 관계의 주인은 외래키를 관리하는 쪽을 정해주는 것이다.  
외래키를 들고 있는 쪽에서 변경, 삭제 등 관리하는 것이 효율적이니,  
일대다(다대일) 관계에서 외래키를 가진 다(Many) 쪽으로 주인을 정한다.  

다대다 관계를 일대다 - 다대일로 풀어 놓은 상황이니,  
연관 관계의 주인은 다(Many) 쪽인 교차 엔티티로 맞게 되어있다.  